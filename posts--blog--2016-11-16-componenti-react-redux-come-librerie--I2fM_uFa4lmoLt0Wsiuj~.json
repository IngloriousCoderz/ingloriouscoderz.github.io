{"data":{"title":"Componenti react/redux come librerie","description":"Qualche trucchetto per creare una libreria con Redux, violando la Singola Sorgente di Verità.","author":"IceOnFire","_entry":"posts\\blog\\2016-11-16-componenti-react-redux-come-librerie.md","page":"post","name":"componenti-react-redux-come-librerie","category":"blog","date":"2016-11-16T00:00:00.000Z","url":"/blog/componenti-react-redux-come-librerie"},"content":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"L'ecosistema creato da Facebook sta tirando fuori un gioiellino dopo l'altro: dopo "},{"type":"element","tagName":"a","properties":{"href":"https://facebook.github.io/react/"},"children":[{"type":"text","value":"react"}]},{"type":"text","value":" e "},{"type":"element","tagName":"a","properties":{"href":"http://redux.js.org/"},"children":[{"type":"text","value":"redux"}]},{"type":"text","value":" di recente è anche uscito "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/facebookincubator/create-react-app"},"children":[{"type":"text","value":"create-react-app"}]},{"type":"text","value":", che permette di arrivare da zero ad app funzionante in un unico comando. Ma che succede se vogliamo pubblicare un componente React da usare come libreria per altri progetti? E se lo stato del componente fosse così complesso da richiedere un contenitore di stati come Redux? Queste sono le domande che mi sono dovuto porre quando ho creato "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/IngloriousCoderz/react-property-grid"},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"react-property-grid"}]}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Affrontiamo le domande una per volta."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Si può usare create-react-app per pubblicare librerie invece che app? Nì. Al momento in cui scrivo, "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"create-react-app"}]},{"type":"text","value":" è pensato per le app e "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/facebookincubator/create-react-app/issues/423#issuecomment-250752431"},"children":[{"type":"text","value":"non intende gestire la creazione di librerie nel breve tempo"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tuttavia la comodità di "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"create-react-app"}]},{"type":"text","value":" rende difficile rinunciarci e fortunatamente gli script che include sono molto ben fatti e documentati, perciò quello che consiglio è di:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"creare il progetto con "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"create-react-app"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\"espellerlo\" con "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"npm run eject"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"modificare il "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"webpack.config.prod.dll"}]},{"type":"text","value":" in modo che produca una libreria"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Purtroppo il processo di "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"eject"}]},{"type":"text","value":", essendo irreversibile, ci impedisce di rimanere facilmente al passo con versioni future dei "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"react-scripts"}]},{"type":"text","value":", ma in assenza di soluzioni migliori al momento il gioco vale la candela."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Il terzo punto consiste nel produrre un file simile a quello che si trova "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/IngloriousCoderz/react-property-grid/blob/master/config/webpack.config.prod.js"},"children":[{"type":"text","value":"qui"}]},{"type":"text","value":", in particolare:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"output"}]},{"type":"text","value":" specifica un nome di file ben preciso e un nome per la libreria"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"text","value":"output: {\n  path: paths.appBuild,\n  filename: 'index.js',\n  library: 'react-property-grid',\n  libraryTarget: 'umd'\n}\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"externals"}]},{"type":"text","value":" dichiara tutte le dipendenze che non vogliamo includere nel bundle, ma vogliamo richiamarle come peer dependencies:"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"text","value":"externals: {\n  'json-schema-deref-local': 'json-schema-deref-local',\n  'jsonpath': 'jsonpath',\n  'react': 'react',\n  'react-dom': 'react-dom',\n  'react-redux': 'react-redux',\n  'react-sortable-hoc': 'react-sortable-hoc',\n  'react-throttle': 'react-throttle',\n  'redux': 'redux',\n  'tv4': 'tv4',\n  'uuid': 'uuid'\n}\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"come fatto per la parte JavaScript, anche un eventuale CSS acquista un nome preciso; la parte HTML invece viene spenta:"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"text","value":"plugins: [\n  // new HtmlWebpackPlugin({...}),\n  ...,\n  new ExtractTextPlugin('index.css')\n]\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"a questo punto senza altre modifiche il progetto viene compilato come un "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"index.js"}]},{"type":"text","value":" e un "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"index.css"}]},{"type":"text","value":" nella directory "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"build"}]},{"type":"text","value":". Se invece vogliamo modificare la directory di destinazione, possiamo farlo in "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"paths.js"}]},{"type":"text","value":":"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"text","value":"module.exports = {\n  appBuild: resolveApp('dist'),//resolveApp('build'),\n  ...\n};\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"infine modifichiamo il nostro "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"package.json"}]},{"type":"text","value":" in modo che si comporti come una libreria:"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"text","value":"{\n  \"name\": \"react-property-grid\",\n  \"version\": \"0.1.0\",\n  \"main\": \"dist/index.js\",\n  \"scripts\": {\n    \"prepublish\": \"npm run build\",\n    ...\n  },\n  ...\n}\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Lo script "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"prepublish"}]},{"type":"text","value":" fa un build appena prima di pubblicare il progetto su npm, pertanto fa in modo che non dobbiamo tenerci nel repository la directory "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"dist"}]},{"type":"text","value":". Possiamo quindi aggiungere questa directory nel "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":".gitignore"}]},{"type":"text","value":" (ma stiamo attenti a non metterla nel "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":".npmignore"}]},{"type":"text","value":", altrimenti NPM si terrà solo i sorgenti e non la libreria vera e propria)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"E questa era la parte facile."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"La parte difficile è stabilire dove tenere lo stato del componente: dato che uno dei punti cardine di redux è la "},{"type":"element","tagName":"a","properties":{"href":"http://redux.js.org/docs/introduction/ThreePrinciples.html#single-source-of-truth"},"children":[{"type":"text","value":"singola sorgente di verità"}]},{"type":"text","value":", verrebbe da tentare di esporre nella libreria un riduttore da agganciare allo store dell'app che la ospita. Tuttavia, oltre che essere un'operazione molto macchinosa, non porta alcun vero vantaggio. Anzi, Lo stato di "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"react-property-grid"}]},{"type":"text","value":" interessa solo a "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"react-property-grid"}]},{"type":"text","value":", e l'app è solo interessata al suo output finale."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"La soluzione è una violazione al principio di unica sorgente di verità: la root del componente di libreria avrà il suo store personale. Questo comportamento è descritto anche nel sito di redux come "},{"type":"element","tagName":"a","properties":{"href":"http://redux.js.org/docs/recipes/IsolatingSubapps.html"},"children":[{"type":"text","value":"Isolating Redux Sub-Apps"}]},{"type":"text","value":": in circostanze molto specifiche (come la nostra) è concesso di disporre di più di uno store."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Il trucco consiste nell'istanziare lo store nel costruttore del componente, in modo che ce ne sia solo uno per ogni istanza del componente. Aggiungo un pezzo:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"text","value":"class SubApp extends Component {\n  constructor(props) {\n    super(props)\n    this.store = createStore(reducer)\n\n    this.store.subscribe(() => {\n      const state = this.store.getState()\n      props.onChange(state.data)\n    })\n\n    this.store.dispatch(init(props.data))\n  }\n\n  componentWillUpdate(nextProps) {\n    this.store.dispatch(init(nextProps.data))\n  }\n\n  render() {\n    return (\n      <Provider store={this.store}>\n        <App />\n      </Provider>\n    )\n  }\n}\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Come si può notare lo stato viene inizializzato nel costruttore grazie a un apposito actionCreator e viene aggiornato a ogni nuova proprietà (ovviamente si possono limitare gli aggiornamenti con il solito metodo "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"shouldComponentUpdate(nextProps)"}]},{"type":"text","value":"). Per comunicare con l'esterno si può aggiungere allo store un listener che chiama una funzione onChange definita altrove."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Infine un'altra cosa che non viene citata nell'articolo è il caso in cui la parent app abbia anch'essa uno store: in questo caso per evitare conflitti suggerisco di aggiungere "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/emmenko/react-redux-custom-store"},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"react-redux-custom-store"}]}]},{"type":"text","value":", che permette di associare un nome univoco a ogni store del sistema."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Se si usa "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/zalmoxisus/redux-devtools-extension"},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"redux-devtools-extension"}]}]},{"type":"text","value":" bisogna tenere presente che ora gli store sono due, e si possono selezionare dal menù a tendina in alto a destra con la dicitura \"Autoselect instances\", che purtroppo al momento mostra due istanze con lo stesso nome anziché usare il nome custom che abbiamo definito:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"img","properties":{"src":"/static/images/blog/componenti-react-redux-come-librerie/store-instances.png","alt":"store multipli in redux-devtools-extension"},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Speriamo che un giorno Facebook cerchi di rendere la vita più semplice non solo agli sviluppatori di app ma anche ai produttori di librerie. Nel frattempo non possiamo far altro che apprezzare l'enorme sforzo che già stanno facendo e magari contribuire, documentando best practice o creare noi stessi una "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"create-react-lib"}]},{"type":"text","value":"!"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"# IceOnFire\n"}]}]}],"data":{"quirksMode":false}},"raw":"\r\nL'ecosistema creato da Facebook sta tirando fuori un gioiellino dopo l'altro: dopo [react](https://facebook.github.io/react/) e [redux](http://redux.js.org/) di recente è anche uscito [create-react-app](https://github.com/facebookincubator/create-react-app), che permette di arrivare da zero ad app funzionante in un unico comando. Ma che succede se vogliamo pubblicare un componente React da usare come libreria per altri progetti? E se lo stato del componente fosse così complesso da richiedere un contenitore di stati come Redux? Queste sono le domande che mi sono dovuto porre quando ho creato [`react-property-grid`](https://github.com/IngloriousCoderz/react-property-grid).\r\n\r\nAffrontiamo le domande una per volta.\r\n\r\nSi può usare create-react-app per pubblicare librerie invece che app? Nì. Al momento in cui scrivo, `create-react-app` è pensato per le app e [non intende gestire la creazione di librerie nel breve tempo](https://github.com/facebookincubator/create-react-app/issues/423#issuecomment-250752431).\r\n\r\nTuttavia la comodità di `create-react-app` rende difficile rinunciarci e fortunatamente gli script che include sono molto ben fatti e documentati, perciò quello che consiglio è di:\r\n\r\n1. creare il progetto con `create-react-app`\r\n2. \"espellerlo\" con `npm run eject`\r\n3. modificare il `webpack.config.prod.dll` in modo che produca una libreria\r\n\r\nPurtroppo il processo di `eject`, essendo irreversibile, ci impedisce di rimanere facilmente al passo con versioni future dei `react-scripts`, ma in assenza di soluzioni migliori al momento il gioco vale la candela.\r\n\r\nIl terzo punto consiste nel produrre un file simile a quello che si trova [qui](https://github.com/IngloriousCoderz/react-property-grid/blob/master/config/webpack.config.prod.js), in particolare:\r\n\r\n- `output` specifica un nome di file ben preciso e un nome per la libreria\r\n\r\n```js\r\noutput: {\r\n  path: paths.appBuild,\r\n  filename: 'index.js',\r\n  library: 'react-property-grid',\r\n  libraryTarget: 'umd'\r\n}\r\n```\r\n\r\n- `externals` dichiara tutte le dipendenze che non vogliamo includere nel bundle, ma vogliamo richiamarle come peer dependencies:\r\n\r\n```js\r\nexternals: {\r\n  'json-schema-deref-local': 'json-schema-deref-local',\r\n  'jsonpath': 'jsonpath',\r\n  'react': 'react',\r\n  'react-dom': 'react-dom',\r\n  'react-redux': 'react-redux',\r\n  'react-sortable-hoc': 'react-sortable-hoc',\r\n  'react-throttle': 'react-throttle',\r\n  'redux': 'redux',\r\n  'tv4': 'tv4',\r\n  'uuid': 'uuid'\r\n}\r\n```\r\n\r\n- come fatto per la parte JavaScript, anche un eventuale CSS acquista un nome preciso; la parte HTML invece viene spenta:\r\n\r\n```js\r\nplugins: [\r\n  // new HtmlWebpackPlugin({...}),\r\n  ...,\r\n  new ExtractTextPlugin('index.css')\r\n]\r\n```\r\n\r\n- a questo punto senza altre modifiche il progetto viene compilato come un `index.js` e un `index.css` nella directory `build`. Se invece vogliamo modificare la directory di destinazione, possiamo farlo in `paths.js`:\r\n\r\n```js\r\nmodule.exports = {\r\n  appBuild: resolveApp('dist'),//resolveApp('build'),\r\n  ...\r\n};\r\n```\r\n\r\n- infine modifichiamo il nostro `package.json` in modo che si comporti come una libreria:\r\n\r\n```js\r\n{\r\n  \"name\": \"react-property-grid\",\r\n  \"version\": \"0.1.0\",\r\n  \"main\": \"dist/index.js\",\r\n  \"scripts\": {\r\n    \"prepublish\": \"npm run build\",\r\n    ...\r\n  },\r\n  ...\r\n}\r\n```\r\n\r\nLo script `prepublish` fa un build appena prima di pubblicare il progetto su npm, pertanto fa in modo che non dobbiamo tenerci nel repository la directory `dist`. Possiamo quindi aggiungere questa directory nel `.gitignore` (ma stiamo attenti a non metterla nel `.npmignore`, altrimenti NPM si terrà solo i sorgenti e non la libreria vera e propria).\r\n\r\nE questa era la parte facile.\r\n\r\nLa parte difficile è stabilire dove tenere lo stato del componente: dato che uno dei punti cardine di redux è la [singola sorgente di verità](http://redux.js.org/docs/introduction/ThreePrinciples.html#single-source-of-truth), verrebbe da tentare di esporre nella libreria un riduttore da agganciare allo store dell'app che la ospita. Tuttavia, oltre che essere un'operazione molto macchinosa, non porta alcun vero vantaggio. Anzi, Lo stato di `react-property-grid` interessa solo a `react-property-grid`, e l'app è solo interessata al suo output finale.\r\n\r\nLa soluzione è una violazione al principio di unica sorgente di verità: la root del componente di libreria avrà il suo store personale. Questo comportamento è descritto anche nel sito di redux come [Isolating Redux Sub-Apps](http://redux.js.org/docs/recipes/IsolatingSubapps.html): in circostanze molto specifiche (come la nostra) è concesso di disporre di più di uno store.\r\n\r\nIl trucco consiste nell'istanziare lo store nel costruttore del componente, in modo che ce ne sia solo uno per ogni istanza del componente. Aggiungo un pezzo:\r\n\r\n```js\r\nclass SubApp extends Component {\r\n  constructor(props) {\r\n    super(props)\r\n    this.store = createStore(reducer)\r\n\r\n    this.store.subscribe(() => {\r\n      const state = this.store.getState()\r\n      props.onChange(state.data)\r\n    })\r\n\r\n    this.store.dispatch(init(props.data))\r\n  }\r\n\r\n  componentWillUpdate(nextProps) {\r\n    this.store.dispatch(init(nextProps.data))\r\n  }\r\n\r\n  render() {\r\n    return (\r\n      <Provider store={this.store}>\r\n        <App />\r\n      </Provider>\r\n    )\r\n  }\r\n}\r\n```\r\n\r\nCome si può notare lo stato viene inizializzato nel costruttore grazie a un apposito actionCreator e viene aggiornato a ogni nuova proprietà (ovviamente si possono limitare gli aggiornamenti con il solito metodo `shouldComponentUpdate(nextProps)`). Per comunicare con l'esterno si può aggiungere allo store un listener che chiama una funzione onChange definita altrove.\r\n\r\nInfine un'altra cosa che non viene citata nell'articolo è il caso in cui la parent app abbia anch'essa uno store: in questo caso per evitare conflitti suggerisco di aggiungere [`react-redux-custom-store`](https://github.com/emmenko/react-redux-custom-store), che permette di associare un nome univoco a ogni store del sistema.\r\n\r\nSe si usa [`redux-devtools-extension`](https://github.com/zalmoxisus/redux-devtools-extension) bisogna tenere presente che ora gli store sono due, e si possono selezionare dal menù a tendina in alto a destra con la dicitura \"Autoselect instances\", che purtroppo al momento mostra due istanze con lo stesso nome anziché usare il nome custom che abbiamo definito:\r\n\r\n![store multipli in redux-devtools-extension](/static/images/blog/componenti-react-redux-come-librerie/store-instances.png)\r\n\r\nSperiamo che un giorno Facebook cerchi di rendere la vita più semplice non solo agli sviluppatori di app ma anche ai produttori di librerie. Nel frattempo non possiamo far altro che apprezzare l'enorme sforzo che già stanno facendo e magari contribuire, documentando best practice o creare noi stessi una `create-react-lib`!\r\n\r\n    # IceOnFire\r\n"}